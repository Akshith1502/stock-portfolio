{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm top-card">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="A-Dash logo" class="logo-img">
          <div>
            <h2 class="mb-1 fw-bold">A-Dash Portfolio Dashboard</h2>
            <p class="text-muted mb-0">Track long-term and short-term profits &amp; losses with a clean stock overview.</p>
          </div>
        </div>
        <div class="totals d-flex flex-wrap gap-3 mt-3 mt-md-0">
          <div class="total-box">
            <span class="label">Total Invested</span>
            <span class="value">${{ total_invested }}</span>
          </div>
          <div class="total-box">
            <span class="label">Current Value</span>
            <span class="value">${{ total_value }}</span>
          </div>
          <div class="total-box {% if total_profit >= 0 %}profit{% else %}loss{% endif %}">
            <span class="label">Overall P/L</span>
            <span class="value">
              {% if total_profit >= 0 %}+{% endif %}${{ total_profit }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LONG / SHORT SUMMARY -->
<div class="row mb-3">
  <div class="col-md-6 mb-2">
    <div class="card shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6 class="text-muted text-uppercase small mb-1">Long Term P/L (&gt; 1 year)</h6>
          <h4 class="{% if total_long_pl >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
            {% if total_long_pl >= 0 %}+{% endif %}${{ total_long_pl }}
          </h4>
        </div>
        <span class="badge bg-success-subtle text-success border border-success-subtle">Long Term</span>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-2">
    <div class="card shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6 class="text-muted text-uppercase small mb-1">Short Term P/L (&le; 1 year)</h6>
          <h4 class="{% if total_short_pl >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
            {% if total_short_pl >= 0 %}+{% endif %}${{ total_short_pl }}
          </h4>
        </div>
        <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Short Term</span>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- LEFT: Add Stock + Watchlist + Trending -->
  <div class="col-lg-3 mb-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white border-0">
        <h5 class="mb-0 fw-bold">Add / Update Stock</h5>
      </div>
      <div class="card-body">
        <form method="POST">
          <div class="mb-2">
            <label class="form-label small">Symbol</label>
            <input type="text" name="symbol" class="form-control form-control-sm" placeholder="e.g. AAPL" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">Quantity</label>
            <input type="number" name="quantity" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">Buy Price</label>
            <input type="number" step="0.01" name="buy_price" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">Buy Date</label>
            <input type="date" name="buy_date" class="form-control form-control-sm" required>
          </div>
          <div class="mb-3">
            <label class="form-label small">Notes</label>
            <input type="text" name="notes" class="form-control form-control-sm" placeholder="Optional note">
          </div>
          <button class="btn btn-primary w-100 btn-sm">Save</button>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Watchlist</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="/add_watch" class="d-flex mb-3 gap-2">
          <input type="text" name="symbol" class="form-control form-control-sm" placeholder="Add symbol">
          <button class="btn btn-outline-secondary btn-sm">Add</button>
        </form>
        {% if watchlist %}
          <ul class="list-group list-group-flush">
            {% for w in watchlist %}
            <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">{{ w }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted small mb-0">No stocks in watchlist yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Trending Stocks</h5>
      </div>
      <div class="card-body">
        {% for t in trending %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-semibold">{{ t.symbol }}</span>
          <span class="badge bg-light text-success border border-success">${{ t.price }}</span>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- CENTER: Portfolio + Chart -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Portfolio Holdings</h5>
        <span class="text-muted small">No duplicates â€“ quantities merged, avg price updated.</span>
      </div>
      <div class="card-body table-responsive">
        {% if portfolio %}
        <table class="table table-sm align-middle portfolio-table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Avg Buy</th>
              <th class="text-end">Live</th>
              <th class="text-end">Invested</th>
              <th class="text-end">Current</th>
              <th class="text-end">P/L</th>
              <th class="text-end">Type</th>
            </tr>
          </thead>
          <tbody>
            {% for s in portfolio %}
            <tr>
              <td>
                <span class="fw-bold">{{ s.symbol }}</span>
                <div class="small text-muted">{{ s.buy_date }}</div>
                {% if s.notes %}
                  <div class="small text-muted">{{ s.notes }}</div>
                {% endif %}
              </td>
              <td class="text-end">{{ s.qty }}</td>
              <td class="text-end">${{ s.bp }}</td>
              <td class="text-end">
                {% if s.invalid %}
                  <span class="text-muted">N/A</span>
                {% else %}
                  ${{ s.live }}
                {% endif %}
              </td>
              <td class="text-end">${{ s.invest }}</td>
              <td class="text-end">${{ s.current }}</td>
              <td class="text-end">
                {% if s.profit >= 0 %}
                  <span class="text-success fw-semibold">+${{ s.profit }}</span>
                {% else %}
                  <span class="text-danger fw-semibold">{{ s.profit }}</span>
                {% endif %}
              </td>
              <td class="text-end">
                {% if s.holding_type == "Long" %}
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Long</span>
                {% elif s.holding_type == "Short" %}
                  <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Short</span>
                {% else %}
                  <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">N/A</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted mb-0">No stocks yet. Add your first holding on the left.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Profit / Loss by Stock</h5>
      </div>
      <div class="card-body">
        <canvas id="plChart" height="140"></canvas>
      </div>
    </div>
  </div>

  <!-- RIGHT: Alerts -->
  <div class="col-lg-3 mb-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white border-0">
        <h5 class="mb-0 fw-bold">Price Alerts</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="/add_alert" class="mb-3">
          <div class="mb-2">
            <label class="form-label small">Symbol</label>
            <input type="text" name="symbol" class="form-control form-control-sm" placeholder="e.g. TSLA" required>
          </div>
          <div class="mb-3">
            <label class="form-label small">Target Price</label>
            <input type="number" step="0.01" name="target" class="form-control form-control-sm" required>
          </div>
          <button class="btn btn-danger w-100 btn-sm">Set Alert</button>
        </form>

        {% if alerts %}
          <table class="table table-sm small">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Target</th>
                <th>Live</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for a in alerts %}
              <tr>
                <td>{{ a.symbol }}</td>
                <td>${{ a.target }}</td>
                <td>${{ a.live }}</td>
                <td>
                  {% if a.hit %}
                    <span class="badge bg-success">Hit</span>
                  {% else %}
                    <span class="badge bg-secondary">Waiting</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted small mb-0">No alerts yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = [{% for s in portfolio %}"{{ s.symbol }}",{% endfor %}];
  const dataPL = [{% for s in portfolio %}{{ s.profit }},{% endfor %}];

  const ctx = document.getElementById('plChart').getContext('2d');
  const plChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Profit / Loss',
        data: dataPL,
        borderWidth: 1,
        backgroundColor: dataPL.map(v => v >= 0 ? 'rgba(25, 135, 84, 0.7)' : 'rgba(220, 53, 69, 0.7)'),
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: { y: { beginAtZero: true } }
    }
  });
</script>

{% endblock %}
